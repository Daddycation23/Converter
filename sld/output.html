<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrical Single Line Diagram</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: inline-block;
        }
        canvas {
            border: 1px solid #ddd;
            background-color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="diagram" width="1290" height="1020"></canvas>
    </div>
    <script>
        const canvas = document.getElementById('diagram');
        const ctx = canvas.getContext('2d');
        
        const components = [{"id":"inverter_0","type":"inverter","x":50,"y":540,"label":"Inverter 1"},{"id":"isolator_0_0","type":"isolator","x":230,"y":170,"label":"Isolator 1-1"},{"id":"pv_0_0_0_0","type":"pvString","x":380,"y":170,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_0_0_1","type":"pvString","x":460,"y":170,"label":""},{"id":"pv_0_0_0_2","type":"pvString","x":540,"y":170,"label":""},{"id":"pv_0_0_0_3","type":"pvString","x":620,"y":170,"label":""},{"id":"pv_0_0_0_4","type":"pvString","x":700,"y":170,"label":""},{"id":"pv_0_0_0_5","type":"pvString","x":780,"y":170,"label":""},{"id":"pv_0_0_0_6","type":"pvString","x":860,"y":170,"label":""},{"id":"pv_0_0_0_7","type":"pvString","x":940,"y":170,"label":""},{"id":"pv_0_0_0_8","type":"pvString","x":1020,"y":170,"label":""},{"id":"pv_0_0_0_9","type":"pvString","x":1100,"y":170,"label":""},{"id":"pv_0_0_1_0","type":"pvString","x":380,"y":240,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_0_1_1","type":"pvString","x":460,"y":240,"label":""},{"id":"pv_0_0_1_2","type":"pvString","x":540,"y":240,"label":""},{"id":"pv_0_0_1_3","type":"pvString","x":620,"y":240,"label":""},{"id":"pv_0_0_1_4","type":"pvString","x":700,"y":240,"label":""},{"id":"pv_0_0_1_5","type":"pvString","x":780,"y":240,"label":""},{"id":"pv_0_0_1_6","type":"pvString","x":860,"y":240,"label":""},{"id":"pv_0_0_1_7","type":"pvString","x":940,"y":240,"label":""},{"id":"pv_0_0_1_8","type":"pvString","x":1020,"y":240,"label":""},{"id":"pv_0_0_1_9","type":"pvString","x":1100,"y":240,"label":""},{"id":"pv_0_0_2_0","type":"pvString","x":380,"y":310,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_0_2_1","type":"pvString","x":460,"y":310,"label":""},{"id":"pv_0_0_2_2","type":"pvString","x":540,"y":310,"label":""},{"id":"pv_0_0_2_3","type":"pvString","x":620,"y":310,"label":""},{"id":"pv_0_0_2_4","type":"pvString","x":700,"y":310,"label":""},{"id":"pv_0_0_2_5","type":"pvString","x":780,"y":310,"label":""},{"id":"pv_0_0_2_6","type":"pvString","x":860,"y":310,"label":""},{"id":"pv_0_0_2_7","type":"pvString","x":940,"y":310,"label":""},{"id":"pv_0_0_2_8","type":"pvString","x":1020,"y":310,"label":""},{"id":"pv_0_0_2_9","type":"pvString","x":1100,"y":310,"label":""},{"id":"pv_0_0_3_0","type":"pvString","x":380,"y":380,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_0_3_1","type":"pvString","x":460,"y":380,"label":""},{"id":"pv_0_0_3_2","type":"pvString","x":540,"y":380,"label":""},{"id":"pv_0_0_3_3","type":"pvString","x":620,"y":380,"label":""},{"id":"pv_0_0_3_4","type":"pvString","x":700,"y":380,"label":""},{"id":"pv_0_0_3_5","type":"pvString","x":780,"y":380,"label":""},{"id":"pv_0_0_3_6","type":"pvString","x":860,"y":380,"label":""},{"id":"pv_0_0_3_7","type":"pvString","x":940,"y":380,"label":""},{"id":"pv_0_0_3_8","type":"pvString","x":1020,"y":380,"label":""},{"id":"pv_0_0_3_9","type":"pvString","x":1100,"y":380,"label":""},{"id":"isolator_0_1","type":"isolator","x":230,"y":530,"label":"Isolator 1-2"},{"id":"pv_0_1_0_0","type":"pvString","x":380,"y":530,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_1_0_1","type":"pvString","x":460,"y":530,"label":""},{"id":"pv_0_1_0_2","type":"pvString","x":540,"y":530,"label":""},{"id":"pv_0_1_0_3","type":"pvString","x":620,"y":530,"label":""},{"id":"pv_0_1_0_4","type":"pvString","x":700,"y":530,"label":""},{"id":"pv_0_1_0_5","type":"pvString","x":780,"y":530,"label":""},{"id":"pv_0_1_0_6","type":"pvString","x":860,"y":530,"label":""},{"id":"pv_0_1_0_7","type":"pvString","x":940,"y":530,"label":""},{"id":"pv_0_1_0_8","type":"pvString","x":1020,"y":530,"label":""},{"id":"pv_0_1_0_9","type":"pvString","x":1100,"y":530,"label":""},{"id":"pv_0_1_1_0","type":"pvString","x":380,"y":600,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_1_1_1","type":"pvString","x":460,"y":600,"label":""},{"id":"pv_0_1_1_2","type":"pvString","x":540,"y":600,"label":""},{"id":"pv_0_1_1_3","type":"pvString","x":620,"y":600,"label":""},{"id":"pv_0_1_1_4","type":"pvString","x":700,"y":600,"label":""},{"id":"pv_0_1_1_5","type":"pvString","x":780,"y":600,"label":""},{"id":"pv_0_1_1_6","type":"pvString","x":860,"y":600,"label":""},{"id":"pv_0_1_1_7","type":"pvString","x":940,"y":600,"label":""},{"id":"pv_0_1_1_8","type":"pvString","x":1020,"y":600,"label":""},{"id":"pv_0_1_1_9","type":"pvString","x":1100,"y":600,"label":""},{"id":"pv_0_1_2_0","type":"pvString","x":380,"y":670,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_1_2_1","type":"pvString","x":460,"y":670,"label":""},{"id":"pv_0_1_2_2","type":"pvString","x":540,"y":670,"label":""},{"id":"pv_0_1_2_3","type":"pvString","x":620,"y":670,"label":""},{"id":"pv_0_1_2_4","type":"pvString","x":700,"y":670,"label":""},{"id":"pv_0_1_2_5","type":"pvString","x":780,"y":670,"label":""},{"id":"pv_0_1_2_6","type":"pvString","x":860,"y":670,"label":""},{"id":"pv_0_1_2_7","type":"pvString","x":940,"y":670,"label":""},{"id":"pv_0_1_2_8","type":"pvString","x":1020,"y":670,"label":""},{"id":"pv_0_1_2_9","type":"pvString","x":1100,"y":670,"label":""},{"id":"pv_0_1_3_0","type":"pvString","x":380,"y":740,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_1_3_1","type":"pvString","x":460,"y":740,"label":""},{"id":"pv_0_1_3_2","type":"pvString","x":540,"y":740,"label":""},{"id":"pv_0_1_3_3","type":"pvString","x":620,"y":740,"label":""},{"id":"pv_0_1_3_4","type":"pvString","x":700,"y":740,"label":""},{"id":"pv_0_1_3_5","type":"pvString","x":780,"y":740,"label":""},{"id":"pv_0_1_3_6","type":"pvString","x":860,"y":740,"label":""},{"id":"pv_0_1_3_7","type":"pvString","x":940,"y":740,"label":""},{"id":"pv_0_1_3_8","type":"pvString","x":1020,"y":740,"label":""},{"id":"pv_0_1_3_9","type":"pvString","x":1100,"y":740,"label":""},{"id":"pv_0_1_4_0","type":"pvString","x":380,"y":810,"label":"Panasonic 330W HiT (10 panels)"},{"id":"pv_0_1_4_1","type":"pvString","x":460,"y":810,"label":""},{"id":"pv_0_1_4_2","type":"pvString","x":540,"y":810,"label":""},{"id":"pv_0_1_4_3","type":"pvString","x":620,"y":810,"label":""},{"id":"pv_0_1_4_4","type":"pvString","x":700,"y":810,"label":""},{"id":"pv_0_1_4_5","type":"pvString","x":780,"y":810,"label":""},{"id":"pv_0_1_4_6","type":"pvString","x":860,"y":810,"label":""},{"id":"pv_0_1_4_7","type":"pvString","x":940,"y":810,"label":""},{"id":"pv_0_1_4_8","type":"pvString","x":1020,"y":810,"label":""},{"id":"pv_0_1_4_9","type":"pvString","x":1100,"y":810,"label":""}];
        const connections = [{"from":"inverter_0","to":"isolator_0_0","type":"daisy_positive"},{"from":"isolator_0_0","to":"inverter_0","type":"daisy_negative_return"},{"from":"isolator_0_0","to":"pv_0_0_0_0","type":"daisy_positive"},{"from":"pv_0_0_0_0","to":"pv_0_0_0_1","type":"daisy_positive"},{"from":"pv_0_0_0_1","to":"pv_0_0_0_2","type":"daisy_positive"},{"from":"pv_0_0_0_2","to":"pv_0_0_0_3","type":"daisy_positive"},{"from":"pv_0_0_0_3","to":"pv_0_0_0_4","type":"daisy_positive"},{"from":"pv_0_0_0_4","to":"pv_0_0_0_5","type":"daisy_positive"},{"from":"pv_0_0_0_5","to":"pv_0_0_0_6","type":"daisy_positive"},{"from":"pv_0_0_0_6","to":"pv_0_0_0_7","type":"daisy_positive"},{"from":"pv_0_0_0_7","to":"pv_0_0_0_8","type":"daisy_positive"},{"from":"pv_0_0_0_8","to":"pv_0_0_0_9","type":"daisy_positive"},{"from":"pv_0_0_0_9","to":"isolator_0_0","type":"daisy_negative_return"},{"from":"isolator_0_0","to":"pv_0_0_1_0","type":"daisy_positive"},{"from":"pv_0_0_1_0","to":"pv_0_0_1_1","type":"daisy_positive"},{"from":"pv_0_0_1_1","to":"pv_0_0_1_2","type":"daisy_positive"},{"from":"pv_0_0_1_2","to":"pv_0_0_1_3","type":"daisy_positive"},{"from":"pv_0_0_1_3","to":"pv_0_0_1_4","type":"daisy_positive"},{"from":"pv_0_0_1_4","to":"pv_0_0_1_5","type":"daisy_positive"},{"from":"pv_0_0_1_5","to":"pv_0_0_1_6","type":"daisy_positive"},{"from":"pv_0_0_1_6","to":"pv_0_0_1_7","type":"daisy_positive"},{"from":"pv_0_0_1_7","to":"pv_0_0_1_8","type":"daisy_positive"},{"from":"pv_0_0_1_8","to":"pv_0_0_1_9","type":"daisy_positive"},{"from":"pv_0_0_1_9","to":"isolator_0_0","type":"daisy_negative_return"},{"from":"isolator_0_0","to":"pv_0_0_2_0","type":"daisy_positive"},{"from":"pv_0_0_2_0","to":"pv_0_0_2_1","type":"daisy_positive"},{"from":"pv_0_0_2_1","to":"pv_0_0_2_2","type":"daisy_positive"},{"from":"pv_0_0_2_2","to":"pv_0_0_2_3","type":"daisy_positive"},{"from":"pv_0_0_2_3","to":"pv_0_0_2_4","type":"daisy_positive"},{"from":"pv_0_0_2_4","to":"pv_0_0_2_5","type":"daisy_positive"},{"from":"pv_0_0_2_5","to":"pv_0_0_2_6","type":"daisy_positive"},{"from":"pv_0_0_2_6","to":"pv_0_0_2_7","type":"daisy_positive"},{"from":"pv_0_0_2_7","to":"pv_0_0_2_8","type":"daisy_positive"},{"from":"pv_0_0_2_8","to":"pv_0_0_2_9","type":"daisy_positive"},{"from":"pv_0_0_2_9","to":"isolator_0_0","type":"daisy_negative_return"},{"from":"isolator_0_0","to":"pv_0_0_3_0","type":"daisy_positive"},{"from":"pv_0_0_3_0","to":"pv_0_0_3_1","type":"daisy_positive"},{"from":"pv_0_0_3_1","to":"pv_0_0_3_2","type":"daisy_positive"},{"from":"pv_0_0_3_2","to":"pv_0_0_3_3","type":"daisy_positive"},{"from":"pv_0_0_3_3","to":"pv_0_0_3_4","type":"daisy_positive"},{"from":"pv_0_0_3_4","to":"pv_0_0_3_5","type":"daisy_positive"},{"from":"pv_0_0_3_5","to":"pv_0_0_3_6","type":"daisy_positive"},{"from":"pv_0_0_3_6","to":"pv_0_0_3_7","type":"daisy_positive"},{"from":"pv_0_0_3_7","to":"pv_0_0_3_8","type":"daisy_positive"},{"from":"pv_0_0_3_8","to":"pv_0_0_3_9","type":"daisy_positive"},{"from":"pv_0_0_3_9","to":"isolator_0_0","type":"daisy_negative_return"},{"from":"inverter_0","to":"isolator_0_1","type":"daisy_positive"},{"from":"isolator_0_1","to":"inverter_0","type":"daisy_negative_return"},{"from":"isolator_0_1","to":"pv_0_1_0_0","type":"daisy_positive"},{"from":"pv_0_1_0_0","to":"pv_0_1_0_1","type":"daisy_positive"},{"from":"pv_0_1_0_1","to":"pv_0_1_0_2","type":"daisy_positive"},{"from":"pv_0_1_0_2","to":"pv_0_1_0_3","type":"daisy_positive"},{"from":"pv_0_1_0_3","to":"pv_0_1_0_4","type":"daisy_positive"},{"from":"pv_0_1_0_4","to":"pv_0_1_0_5","type":"daisy_positive"},{"from":"pv_0_1_0_5","to":"pv_0_1_0_6","type":"daisy_positive"},{"from":"pv_0_1_0_6","to":"pv_0_1_0_7","type":"daisy_positive"},{"from":"pv_0_1_0_7","to":"pv_0_1_0_8","type":"daisy_positive"},{"from":"pv_0_1_0_8","to":"pv_0_1_0_9","type":"daisy_positive"},{"from":"pv_0_1_0_9","to":"isolator_0_1","type":"daisy_negative_return"},{"from":"isolator_0_1","to":"pv_0_1_1_0","type":"daisy_positive"},{"from":"pv_0_1_1_0","to":"pv_0_1_1_1","type":"daisy_positive"},{"from":"pv_0_1_1_1","to":"pv_0_1_1_2","type":"daisy_positive"},{"from":"pv_0_1_1_2","to":"pv_0_1_1_3","type":"daisy_positive"},{"from":"pv_0_1_1_3","to":"pv_0_1_1_4","type":"daisy_positive"},{"from":"pv_0_1_1_4","to":"pv_0_1_1_5","type":"daisy_positive"},{"from":"pv_0_1_1_5","to":"pv_0_1_1_6","type":"daisy_positive"},{"from":"pv_0_1_1_6","to":"pv_0_1_1_7","type":"daisy_positive"},{"from":"pv_0_1_1_7","to":"pv_0_1_1_8","type":"daisy_positive"},{"from":"pv_0_1_1_8","to":"pv_0_1_1_9","type":"daisy_positive"},{"from":"pv_0_1_1_9","to":"isolator_0_1","type":"daisy_negative_return"},{"from":"isolator_0_1","to":"pv_0_1_2_0","type":"daisy_positive"},{"from":"pv_0_1_2_0","to":"pv_0_1_2_1","type":"daisy_positive"},{"from":"pv_0_1_2_1","to":"pv_0_1_2_2","type":"daisy_positive"},{"from":"pv_0_1_2_2","to":"pv_0_1_2_3","type":"daisy_positive"},{"from":"pv_0_1_2_3","to":"pv_0_1_2_4","type":"daisy_positive"},{"from":"pv_0_1_2_4","to":"pv_0_1_2_5","type":"daisy_positive"},{"from":"pv_0_1_2_5","to":"pv_0_1_2_6","type":"daisy_positive"},{"from":"pv_0_1_2_6","to":"pv_0_1_2_7","type":"daisy_positive"},{"from":"pv_0_1_2_7","to":"pv_0_1_2_8","type":"daisy_positive"},{"from":"pv_0_1_2_8","to":"pv_0_1_2_9","type":"daisy_positive"},{"from":"pv_0_1_2_9","to":"isolator_0_1","type":"daisy_negative_return"},{"from":"isolator_0_1","to":"pv_0_1_3_0","type":"daisy_positive"},{"from":"pv_0_1_3_0","to":"pv_0_1_3_1","type":"daisy_positive"},{"from":"pv_0_1_3_1","to":"pv_0_1_3_2","type":"daisy_positive"},{"from":"pv_0_1_3_2","to":"pv_0_1_3_3","type":"daisy_positive"},{"from":"pv_0_1_3_3","to":"pv_0_1_3_4","type":"daisy_positive"},{"from":"pv_0_1_3_4","to":"pv_0_1_3_5","type":"daisy_positive"},{"from":"pv_0_1_3_5","to":"pv_0_1_3_6","type":"daisy_positive"},{"from":"pv_0_1_3_6","to":"pv_0_1_3_7","type":"daisy_positive"},{"from":"pv_0_1_3_7","to":"pv_0_1_3_8","type":"daisy_positive"},{"from":"pv_0_1_3_8","to":"pv_0_1_3_9","type":"daisy_positive"},{"from":"pv_0_1_3_9","to":"isolator_0_1","type":"daisy_negative_return"},{"from":"isolator_0_1","to":"pv_0_1_4_0","type":"daisy_positive"},{"from":"pv_0_1_4_0","to":"pv_0_1_4_1","type":"daisy_positive"},{"from":"pv_0_1_4_1","to":"pv_0_1_4_2","type":"daisy_positive"},{"from":"pv_0_1_4_2","to":"pv_0_1_4_3","type":"daisy_positive"},{"from":"pv_0_1_4_3","to":"pv_0_1_4_4","type":"daisy_positive"},{"from":"pv_0_1_4_4","to":"pv_0_1_4_5","type":"daisy_positive"},{"from":"pv_0_1_4_5","to":"pv_0_1_4_6","type":"daisy_positive"},{"from":"pv_0_1_4_6","to":"pv_0_1_4_7","type":"daisy_positive"},{"from":"pv_0_1_4_7","to":"pv_0_1_4_8","type":"daisy_positive"},{"from":"pv_0_1_4_8","to":"pv_0_1_4_9","type":"daisy_positive"},{"from":"pv_0_1_4_9","to":"isolator_0_1","type":"daisy_negative_return"}];
        const symbols = {"inverter":{"width":80,"height":50,"svg":"<rect x=\"0\" y=\"0\" width=\"80\" height=\"50\" fill=\"white\" stroke=\"black\" stroke-width=\"2\" rx=\"5\"/>\n              <text x=\"40\" y=\"20\" text-anchor=\"middle\" font-size=\"10\" font-weight=\"bold\">INVERTER</text>\n              <text x=\"40\" y=\"35\" text-anchor=\"middle\" font-size=\"8\">AC/DC</text>"},"isolator":{"width":40,"height":40,"svg":"<rect x=\"0\" y=\"0\" width=\"40\" height=\"40\" fill=\"white\" stroke=\"black\" stroke-width=\"2\"/>\n              <circle cx=\"20\" cy=\"20\" r=\"8\" fill=\"none\" stroke=\"black\" stroke-width=\"2\"/>\n              <line x1=\"12\" y1=\"20\" x2=\"28\" y2=\"20\" stroke=\"black\" stroke-width=\"2\"/>\n              <text x=\"20\" y=\"35\" text-anchor=\"middle\" font-size=\"8\">DC ISO</text>"},"pvString":{"width":60,"height":40,"svg":"<rect x=\"0\" y=\"0\" width=\"60\" height=\"40\" fill=\"lightblue\" stroke=\"black\" stroke-width=\"2\"/>\n              <text x=\"30\" y=\"15\" text-anchor=\"middle\" font-size=\"8\" font-weight=\"bold\">PV STRING</text>\n              <text x=\"30\" y=\"28\" text-anchor=\"middle\" font-size=\"7\">Panels</text>"},"connection":{"svg":"<line x1=\"0\" y1=\"0\" x2=\"100\" y2=\"0\" stroke=\"black\" stroke-width=\"2\"/>"}};
        
        const clamp = (value, min, max) => Math.max(min, Math.min(max, value));
        
        const inverterIsolatorMap = {};
        const isolatorSlotLookup = {};
        
        components.forEach(comp => {
            if (comp.type === 'isolator') {
                const inverterIndex = comp.id.split('_')[1];
                if (!inverterIsolatorMap[inverterIndex]) {
                    inverterIsolatorMap[inverterIndex] = [];
                }
                inverterIsolatorMap[inverterIndex].push(comp);
            }
        });
        
        Object.entries(inverterIsolatorMap).forEach(([invIndex, isolators]) => {
            isolators.sort((a, b) => a.y - b.y);
            isolators.forEach((iso, slotIndex) => {
                isolatorSlotLookup[iso.id] = {
                    inverterIndex: invIndex,
                    slotIndex,
                    totalSlots: isolators.length
                };
            });
        });
        
        const getInverterConnectionY = (inverterComp, slotInfo, polarity) => {
            const symbol = symbols[inverterComp.type];
            const inverterHeight = symbol.height;
            const margin = 10;
            const totalSlots = Math.max(1, slotInfo.totalSlots || 1);
            const totalConnections = totalSlots * 2;
            const connectionIndex =
                (slotInfo.slotIndex || 0) * 2 + (polarity === 'positive' ? 0 : 1);
            if (totalConnections <= 1) {
                return inverterComp.y + inverterHeight / 2;
            }
            const availableHeight = Math.max(0, inverterHeight - margin * 2);
            const step =
                totalConnections > 1 ? availableHeight / (totalConnections - 1) : 0;
            return clamp(
                inverterComp.y + margin + step * connectionIndex,
                inverterComp.y + 4,
                inverterComp.y + inverterHeight - 4
            );
        };
        
        // Draw white background
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw connections first
        connections.forEach(conn => {
            const fromComp = components.find(c => c.id === conn.from);
            const toComp = components.find(c => c.id === conn.to);
            
            if (!fromComp || !toComp) return;
            
            const fromSymbol = symbols[fromComp.type];
            const toSymbol = symbols[toComp.type];
            
            if (conn.type === 'daisy_positive') {
                const endX = toComp.x;
                const endY = toComp.y + toSymbol.height / 4;
                
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                if (fromComp.type === 'isolator') {
                    const startX = fromComp.x + fromSymbol.width;
                    const startY = fromComp.y + fromSymbol.height / 4;
                    const midX = Math.max(endX - 40, startX + 10);
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(midX, startY);
                    ctx.lineTo(midX, endY);
                    ctx.lineTo(endX, endY);
                } else if (fromComp.type === 'inverter') {
                    const slotInfo = isolatorSlotLookup[toComp.id] || { slotIndex: 0, totalSlots: 1 };
                    const startY = getInverterConnectionY(fromComp, slotInfo, 'positive');
                    const startX = fromComp.x + fromSymbol.width;
                    
                    const baseOffset = 28;
                    const laneSpacing = 32;
                    const maxLaneX = endX - 20;
                    const laneX = Math.min(startX + baseOffset + (slotInfo.slotIndex * laneSpacing), maxLaneX);
                    const isolatorConnectionY = toComp.y + (toSymbol.height / 4);
                    
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(laneX, startY);
                    ctx.lineTo(laneX, isolatorConnectionY);
                    ctx.lineTo(endX, isolatorConnectionY);
                } else {
                    const startX = fromComp.x + fromSymbol.width;
                    const startY = fromComp.y + fromSymbol.height / 4;
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(endX, endY);
                }
                ctx.stroke();
            } else if (conn.type === 'daisy_negative_return') {
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.beginPath();
                
                if (fromComp.type === 'isolator' && toComp.type === 'inverter') {
                    const slotInfo = isolatorSlotLookup[fromComp.id] || { slotIndex: 0, totalSlots: 1 };
                    const endX = toComp.x + toSymbol.width;
                    const endY = getInverterConnectionY(toComp, slotInfo, 'negative');
                    const startX = fromComp.x + fromSymbol.width;
                    const isolatorConnectionY = fromComp.y + (fromSymbol.height * 3 / 4);
                    
                    const baseOffset = 60;
                    const laneSpacing = 36;
                    const laneX = endX + baseOffset + (slotInfo.slotIndex * laneSpacing);
                    
                    ctx.moveTo(startX, isolatorConnectionY);
                    ctx.lineTo(laneX, isolatorConnectionY);
                    ctx.lineTo(laneX, endY);
                    ctx.lineTo(endX, endY);
                } else {
                    const startX = fromComp.x + fromSymbol.width;
                    const startY = fromComp.y + (fromSymbol.height * 3 / 4);
                    const endX = toComp.x + toSymbol.width;
                    const endY = toComp.y + (toSymbol.height * 3 / 4);
                    const jog = 15;
                    const dropOffset = 25;
                    ctx.moveTo(startX, startY);
                    ctx.lineTo(startX + jog, startY);
                    ctx.lineTo(startX + jog, startY + dropOffset);
                    ctx.lineTo(endX + jog, startY + dropOffset);
                    ctx.lineTo(endX + jog, endY);
                    ctx.lineTo(endX, endY);
                }
                ctx.stroke();
            }
        });
        
        // Draw components
        components.forEach(comp => {
            const symbol = symbols[comp.type];
            
            // Draw component rectangle
            ctx.fillStyle = comp.type === 'pvString' ? 'lightblue' : 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            
            if (comp.type === 'inverter') {
                ctx.beginPath();
                ctx.roundRect(comp.x, comp.y, symbol.width, symbol.height, 5);
                ctx.fill();
                ctx.stroke();
            } else if (comp.type === 'isolator') {
                ctx.fillRect(comp.x, comp.y, symbol.width, symbol.height);
                ctx.strokeRect(comp.x, comp.y, symbol.width, symbol.height);
                
                ctx.beginPath();
                ctx.moveTo(comp.x + 10, comp.y + 20);

                ctx.stroke();
            } else if (comp.type === 'pvString') {
                ctx.fillRect(comp.x, comp.y, symbol.width, symbol.height);
                ctx.strokeRect(comp.x, comp.y, symbol.width, symbol.height);
            }
            
            // Draw label
            if (comp.label) {
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                
                if (comp.type === 'pvString') {
                    ctx.font = '9px Arial';
                    ctx.fillText(comp.label, comp.x + symbol.width / 2, comp.y - 5);
                } else {
                    ctx.font = '12px Arial';
                    ctx.fillText(comp.label, comp.x + symbol.width / 2, comp.y + symbol.height + 15);
                }
            }
        });
    </script>
</body>
</html>