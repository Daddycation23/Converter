<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV Single Line Diagram</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: auto;
        }
        canvas {
            border: 1px solid #ccc;
        }
        h2 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>PV Single Line Diagram</h1>
    
    <div id="diagrams"></div>

    
<script>
  const pvData = {
    "PVArray1": {"inverters":[{"isolators":[{"pvstrings":[{"model":"Panasonic 330W HiT","length":10},{"model":"Panasonic 330W HiT","length":10},{"model":"Panasonic 330W HiT","length":10},{"model":"Panasonic 330W HiT","length":10}]},{"pvstrings":[{"model":"Panasonic 330W HiT","length":10},{"model":"Panasonic 330W HiT","length":10},{"model":"Panasonic 330W HiT","length":10},{"model":"Panasonic 330W HiT","length":10},{"model":"Panasonic 330W HiT","length":10}]}]}]}
  };
</script>


    <script>
        // Constants for drawing
        const CONFIG = {
            panel: { width: 60, height: 40, spacing: 20, borderRadius: 5 },
            isolator: { width: 50, height: 50, margin: 40 },
            inverter: { width: 150, height: 150, margin: 50 },
            stringSpacing: 60, // Vertical space between strings
            colors: {
                positive: 'red',
                negative: 'black',
                panel: '#fff',
                stroke: 'black',
                text: '#000'
            }
        };

        function drawRoundedRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
            ctx.fill(); // Fill first
            ctx.stroke();
        }

        function renderDiagram(name, data) {
            const container = document.createElement('div');
            container.className = 'container';
            container.innerHTML = `<h2>${name}</h2>`;
            
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);
            document.getElementById('diagrams').appendChild(container);
            
            const ctx = canvas.getContext('2d');

            // Calculate Dimensions
            // Max strings in any isolator to determine height
            // Max panels in any string to determine width
            let maxStringLength = 0;
            let totalStrings = 0;
            let maxIsolators = 0;
            
            data.inverters.forEach(inv => {
                if(inv.isolators.length > maxIsolators) maxIsolators = inv.isolators.length;
                inv.isolators.forEach(iso => {
                    totalStrings += iso.pvstrings.length;
                    iso.pvstrings.forEach(str => {
                        if (str.length > maxStringLength) maxStringLength = str.length;
                    });
                });
            });

            // Layout Parameters
            const startX = 50;
            const startY = 50;
            
            // Estimate Canvas Size
            // Width: Inverter Area + Isolator Area + Panel Strings Area
            // Height: Sum of all string heights + margins
            
            // Let's structure it:
            // Inverter (Bottom Left) 
            // Isolators (Above Inverter? Or Right of Inverter?) 
            // Reference "PVArray1.json": 1 Inverter -> 2 Isolators -> Multiple strings.
            // Let's place Inverter on the Left. Isolators to the right. Strings to the right of Isolators.
            // OR: Strings on top, flowing down to Isolators, then to Inverter.
            // Based on standard SLD loops:
            // Panels (Right) -> Isolators (Left/Middle) -> Inverter (Far Left/Bottom).
            
            // Let's go with: Inverter (Bottom Left). Isolators (Above Inverter). Strings (Right of Isolators).
            
            const inverterWidth = CONFIG.inverter.width;
            const isolatorWidth = CONFIG.isolator.width;
            const panelWidth = CONFIG.panel.width;
            const panelSpacing = CONFIG.panel.spacing;
            
            const stringWidth = maxStringLength * (panelWidth + panelSpacing);
            const canvasWidth = startX + inverterWidth + 100 + isolatorWidth + 100 + stringWidth + 100;
            
            // Height depends on number of strings
            // We stack strings vertically.
            // Each Isolator handles N strings.
            // We group strings by Isolator.
            
            const stringHeight = CONFIG.panel.height + CONFIG.stringSpacing;
            const totalHeight = (totalStrings * stringHeight) + 300; // + padding for inverter
            
            canvas.width = canvasWidth;
            canvas.height = totalHeight;
            
            ctx.font = "12px Arial";
            
            // Draw !
            // We'll calculate Y positions as we go.
            let currentY = startY;
            
            // We need to center the inverter vertically relative to its isolators? 
            // Or just place it at the bottom?
            // Let's place Inverter at Bottom Left.
            // Isolators stacked vertically above it?
            // Actually, usually Isolators are near the Inverter.
            // Let's iterate Inverters -> Isolators -> Strings.
            
            let currentStringY = 50; // Start from top
            
            data.inverters.forEach((inverter, invIndex) => {
                const inverterYStart = currentStringY;
                const isolatorPositions = [];
                
                inverter.isolators.forEach((isolator, isoIndex) => {
                    const isolatorYStart = currentStringY;
                    const stringPositions = []; // To store where strings connect
                    
                    isolator.pvstrings.forEach((string, strIndex) => {
                        // Draw String of Panels
                        const stringX = startX + inverterWidth + 150; // Shift right
                        const stringY = currentStringY;
                        
                        // Draw Panels
                        for (let i = 0; i < string.length; i++) {
                            const px = stringX + (i * (panelWidth + panelSpacing));
                            const py = stringY;
                            
                            ctx.strokeStyle = CONFIG.colors.stroke;
                            ctx.fillStyle = CONFIG.colors.panel;
                            ctx.lineWidth = 2; // Ensure consistent line width
                            // Draw Panel Box
                            drawRoundedRect(ctx, px, py, panelWidth, CONFIG.panel.height, CONFIG.panel.borderRadius);
                            // ctx.strokeRect(px, py, panelWidth, CONFIG.panel.height);
                            
                            // Label?
                            // ctx.fillStyle = CONFIG.colors.text;
                            // ctx.fillText(`${i+1}`, px + 5, py + 20);
                        }
                        
                        // WIRING LOGIC
                        // Red (+): From Isolator to First Panel (Leftmost) -> Through Panels -> End
                        // Black (-): From Last Panel (Rightmost) -> Back to Isolator
                        
                        // Let's refine the "Loop" description.
                        // "red line is the positive... connects from the first panel to the last panel"
                        // This implies series connection is drawn in RED.
                        
                        const firstPanelX = stringX;
                        const lastPanelX = stringX + ((string.length - 1) * (panelWidth + panelSpacing));
                        const panelCenterY = stringY + (CONFIG.panel.height / 2);
                        
                        // Series connections (RED)
                        ctx.strokeStyle = CONFIG.colors.positive;
                        ctx.lineWidth = 2;
                        
                        // Between panels
                        ctx.beginPath();
                        for (let i = 0; i < string.length - 1; i++) {
                            const p1x = stringX + (i * (panelWidth + panelSpacing)) + panelWidth; // Right side of P1
                            const p2x = stringX + ((i + 1) * (panelWidth + panelSpacing)); // Left side of P2
                            
                            ctx.moveTo(p1x, panelCenterY);
                            ctx.lineTo(p2x, panelCenterY);
                        }
                        ctx.stroke();
                        
                        // Connection Points for Isolator
                        // Let's say Isolator is at (isolatorX, isolatorCenterY)
                        // We'll draw the Isolator Box later, let's record the connection Y
                        stringPositions.push({
                            y: panelCenterY,
                            startX: firstPanelX,
                            endX: lastPanelX + panelWidth // Right side of last panel
                        });
                        
                        currentStringY += stringHeight;
                    });
                    
                    // Draw Isolator
                    // Position: To the left of the strings, centered vertically relative to its strings
                    // Calculate height based on strings
                    const isoContentHeight = (isolator.pvstrings.length * stringHeight) - CONFIG.stringSpacing;
                    const isoBoxHeight = Math.max(isoContentHeight + 20, 50); // Min 50
                    const isolatorCenterY = isolatorYStart + (isoContentHeight / 2) + (CONFIG.panel.height / 2); 
                    const isolatorY = isolatorCenterY - (isoBoxHeight / 2);
                    const isolatorX = startX + inverterWidth + 50;
                    
                    ctx.strokeStyle = CONFIG.colors.stroke;
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(isolatorX, isolatorY, CONFIG.isolator.width, isoBoxHeight);
                    ctx.strokeRect(isolatorX, isolatorY, CONFIG.isolator.width, isoBoxHeight);
                    
                    ctx.fillStyle = CONFIG.colors.text;
                    ctx.textAlign = "center";
                    ctx.fillText("Isolator", isolatorX + (CONFIG.isolator.width/2), isolatorCenterY);
                    ctx.textAlign = "left";

                    // Connect Strings to Isolator
                    stringPositions.forEach(pos => {
                        // Red (+) to First Panel (Left side)
                        ctx.strokeStyle = CONFIG.colors.positive;
                        ctx.beginPath();
                        ctx.moveTo(isolatorX + CONFIG.isolator.width, pos.y - 5); 
                        ctx.lineTo(pos.startX, pos.y - 5); 
                        ctx.stroke();
                        
                        // Black (-) from Last Panel (Right side) to Isolator
                        ctx.strokeStyle = CONFIG.colors.negative;
                        ctx.beginPath();
                        ctx.moveTo(pos.endX, pos.y); // Right side of last panel
                        
                        const returnY = pos.y + (CONFIG.panel.height / 2) + 10; // Below the panel
                        
                        ctx.lineTo(pos.endX + 10, pos.y); // Out a bit
                        ctx.lineTo(pos.endX + 10, returnY); // Down
                        ctx.lineTo(isolatorX + CONFIG.isolator.width + 10, returnY); // Back left (underneath)
                        ctx.lineTo(isolatorX + CONFIG.isolator.width + 10, pos.y + 5); // Up to Isolator level
                        ctx.lineTo(isolatorX + CONFIG.isolator.width, pos.y + 5); // Into Isolator
                        ctx.stroke();
                    });
                    
                    isolatorPositions.push({
                        x: isolatorX,
                        y: isolatorCenterY
                    });
                });
                
                // Draw Inverter
                // Position: Left of Isolators, Centered relative to all its isolators
                const totalInvContentHeight = currentStringY - inverterYStart - CONFIG.stringSpacing;
                const invBoxHeight = Math.max(totalInvContentHeight + 40, 150);
                const inverterCenterY = inverterYStart + (totalInvContentHeight / 2) + (CONFIG.panel.height / 2);
                const inverterY = inverterCenterY - (invBoxHeight / 2);
                const inverterX = startX;
                
                ctx.strokeStyle = CONFIG.colors.stroke;
                ctx.fillStyle = '#fff';
                drawRoundedRect(ctx, inverterX, inverterY, CONFIG.inverter.width, invBoxHeight, 10);
                
                ctx.fillStyle = CONFIG.colors.text;
                ctx.textAlign = "center";
                ctx.fillText("Inverter", inverterX + (CONFIG.inverter.width/2), inverterCenterY);
                ctx.textAlign = "left";
                
                // Connect Isolators to Inverter
                isolatorPositions.forEach(isoPos => {
                    // Red (+)
                    ctx.strokeStyle = CONFIG.colors.positive;
                    ctx.beginPath();
                    ctx.moveTo(inverterX + CONFIG.inverter.width, isoPos.y - 5);
                    ctx.lineTo(isoPos.x, isoPos.y - 5);
                    ctx.stroke();
                    
                    // Black (-)
                    ctx.strokeStyle = CONFIG.colors.negative;
                    ctx.beginPath();
                    ctx.moveTo(inverterX + CONFIG.inverter.width, isoPos.y + 5);
                    ctx.lineTo(isoPos.x, isoPos.y + 5);
                    ctx.stroke();
                });
            });
        }

        // Render all available data
        for (const [name, data] of Object.entries(pvData)) {
            renderDiagram(name, data);
        }
    </script>
</body>
</html>

